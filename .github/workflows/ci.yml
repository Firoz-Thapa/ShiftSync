strategy:
  fail-fast: false
  matrix:
    node-version: [16.x, 18.x, 20.x]

steps:
  - name: Checkout code
    uses: actions/checkout@v4

  - name: Setup Node.js ${{ matrix.node-version }}
    uses: actions/setup-node@v4
    with:
      node-version: ${{ matrix.node-version }}

  - name: Install backend dependencies
    working-directory: backend
    run: |
      if [ -f package-lock.json ]; then
        echo "Using npm with package-lock.json (backend)"
        npm ci
      elif [ -f yarn.lock ]; then
        echo "Using yarn with yarn.lock (backend)"
        corepack enable
        yarn install --frozen-lockfile
      elif [ -f pnpm-lock.yaml ]; then
        echo "Using pnpm with pnpm-lock.yaml (backend)"
        corepack enable
        pnpm install --frozen-lockfile
      else
        echo "No lockfile found in backend — falling back to npm install"
        npm install
      fi

  - name: Install frontend dependencies
    working-directory: frontend
    run: |
      if [ -f package-lock.json ]; then
        echo "Using npm with package-lock.json (frontend)"
        npm ci
      elif [ -f yarn.lock ]; then
        echo "Using yarn with yarn.lock (frontend)"
        corepack enable
        yarn install --frozen-lockfile
      elif [ -f pnpm-lock.yaml ]; then
        echo "Using pnpm with pnpm-lock.yaml (frontend)"
        corepack enable
        pnpm install --frozen-lockfile
      else
        echo "No lockfile found in frontend — falling back to npm install"
        npm install
      fi

  - name: Run backend lint (if present)
    working-directory: backend
    run: npm run lint || echo "No linting script found in backend, skipping..."

  - name: Run frontend lint (if present)
    working-directory: frontend
    run: npm run lint || echo "No linting script found in frontend, skipping..."

  - name: Run frontend tests
    working-directory: frontend
    run: npm test -- --passWithNoTests --watchAll=false || echo "Frontend tests failed or no tests found"

  - name: Build backend
    working-directory: backend
    run: npm run build
    env:
      CI: false

  - name: Build frontend
    working-directory: frontend
    run: npm run build
    env:
      CI: false